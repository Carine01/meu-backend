name: ‚ö° Performance Alert

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  pull_request:
    branches: [main, develop]

jobs:
  perf-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîç Analyze TypeORM queries
        run: |
          echo "üîç Analyzing database queries for performance issues..."
          
          # Check for queries without proper filtering
          echo "1Ô∏è‚É£ Checking for queries without limits..."
          UNLIMITED_QUERIES=$(grep -r "\.find(\|\.findMany(" src/ --include="*.ts" | grep -v "take:\|skip:\|limit:" | wc -l)
          
          if [ "$UNLIMITED_QUERIES" -gt 5 ]; then
            echo "‚ö†Ô∏è Found $UNLIMITED_QUERIES queries without pagination/limits"
            echo "üí° Consider adding 'take' or 'skip' parameters to prevent loading too much data"
            echo ""
            echo "Queries without limits:"
            grep -r "\.find(\|\.findMany(" src/ --include="*.ts" | grep -v "take:\|skip:\|limit:" | head -10
          fi
          
          echo ""
          echo "2Ô∏è‚É£ Checking for N+1 query patterns..."
          # Look for loops with database queries inside
          LOOP_QUERIES=$(grep -A 5 "for.*of\|forEach" src/ --include="*.ts" | grep -c "\.find\|\.findOne\|\.save\|\.update" || echo "0")
          
          if [ "$LOOP_QUERIES" -gt 0 ]; then
            echo "‚ö†Ô∏è Potential N+1 query patterns detected: $LOOP_QUERIES"
            echo "üí° Consider using batch operations or eager loading with relations"
          fi
          
          echo ""
          echo "3Ô∏è‚É£ Checking for missing eager/lazy loading configuration..."
          FIND_WITHOUT_RELATIONS=$(grep -r "\.findOne(\|\.find(" src/modules/ --include="*.ts" | grep -v "relations:" | wc -l)
          
          if [ "$FIND_WITHOUT_RELATIONS" -gt 10 ]; then
            echo "‚ÑπÔ∏è Found $FIND_WITHOUT_RELATIONS queries without explicit relations"
            echo "üí° Consider explicitly specifying relations to avoid unexpected queries"
          fi
          
          echo ""
          echo "‚úÖ Performance analysis complete"
      
      - name: üîç Check for slow patterns
        run: |
          echo "üîç Checking for known slow patterns..."
          
          # Check for synchronous operations that could be async
          SYNC_OPS=$(grep -r "readFileSync\|writeFileSync" src/ --include="*.ts" | wc -l)
          
          if [ "$SYNC_OPS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $SYNC_OPS synchronous file operations"
            echo "üí° Consider using async alternatives (readFile, writeFile)"
            grep -r "readFileSync\|writeFileSync" src/ --include="*.ts"
          fi
          
          # Check for missing indexes hints (comments suggesting indexes)
          echo ""
          echo "‚ÑπÔ∏è Checking for index hints in entity files..."
          ENTITY_FILES=$(find src/ -name "*.entity.ts" -o -name "*.model.ts" | wc -l)
          INDEX_DECORATORS=$(grep -r "@Index(" src/ --include="*.entity.ts" --include="*.model.ts" | wc -l)
          
          echo "üìä Found $ENTITY_FILES entity files"
          echo "üìä Found $INDEX_DECORATORS @Index decorators"
          
          if [ "$ENTITY_FILES" -gt 0 ] && [ "$INDEX_DECORATORS" -eq 0 ]; then
            echo "‚ö†Ô∏è No database indexes defined"
            echo "üí° Consider adding @Index() decorators to frequently queried fields"
          fi
          
          echo ""
          echo "‚úÖ Pattern check complete"
      
      - name: üìä Performance Summary
        if: always()
        run: |
          echo "üìä Performance Analysis Summary"
          echo "================================"
          echo ""
          echo "‚úÖ Analysis completed successfully"
          echo ""
          echo "üí° Tips for better performance:"
          echo "  - Use pagination (take/skip) for large datasets"
          echo "  - Avoid N+1 queries with eager loading or batch operations"
          echo "  - Add indexes to frequently queried fields"
          echo "  - Use async operations for I/O tasks"
          echo "  - Monitor query execution times in production"
