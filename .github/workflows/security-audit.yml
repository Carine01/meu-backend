name: ðŸ”’ Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  security-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Check for queries without clinicId filter
        run: |
          echo "ðŸ” Searching for vulnerable database queries..."
          
          # Search for find() or findOne() without where clause in modules
          # Note: This is a basic check that may have false positives
          # It looks for methods without 'where' on the same line
          # Review flagged methods manually to confirm if they need clinicId filtering
          VULNERABLE=$(grep -r "\.find()\|\.findOne()" src/modules/ 2>/dev/null | grep -v "where" | wc -l || echo "0")
          
          if [ "$VULNERABLE" -gt 0 ]; then
            echo "ðŸš¨ $VULNERABLE potentially vulnerable methods found!"
            echo "Methods without where clause (may be missing clinicId filter):"
            grep -r "\.find()\|\.findOne()" src/modules/ 2>/dev/null | grep -v "where" || true
            exit 1
          fi
          
          echo "âœ… No obvious query vulnerabilities detected"
      
      - name: ðŸ” Check for unprotected endpoints
        run: |
          echo "ðŸ” Checking for endpoints without guards..."
          
          # Look for HTTP decorators (@Get, @Post, @Delete, @Put, @Patch) that may lack @UseGuards
          # This is a basic check - it counts decorator occurrences
          DECORATORS=$(grep -r "@Get(\|@Post(\|@Delete(\|@Put(\|@Patch(" src/modules/ 2>/dev/null | wc -l || echo "0")
          GUARDS=$(grep -r "@UseGuards(" src/modules/ 2>/dev/null | wc -l || echo "0")
          
          echo "ðŸ“Š Found $DECORATORS HTTP endpoints"
          echo "ðŸ“Š Found $GUARDS @UseGuards decorators"
          
          # Warning if there are endpoints but few guards (not a hard failure)
          if [ "$DECORATORS" -gt 0 ] && [ "$GUARDS" -eq 0 ]; then
            echo "âš ï¸ Warning: Found HTTP endpoints but no @UseGuards decorators"
            echo "âš ï¸ Please ensure all endpoints have proper authentication"
          fi
          
          echo "âœ… Security check completed"
      
      - name: ðŸ” Check for hardcoded secrets
        run: |
          echo "ðŸ” Checking for potential hardcoded secrets..."
          
          # Check for common secret patterns (excluding test files)
          SECRETS=$(grep -r -i "password.*=.*['\"].\{8,\}['\"]" src/ 2>/dev/null | grep -v test | grep -v spec | wc -l || echo "0")
          API_KEYS=$(grep -r "api[_-]key.*=.*['\"].\{10,\}['\"]" src/ 2>/dev/null | grep -v test | grep -v spec | wc -l || echo "0")
          
          if [ "$SECRETS" -gt 0 ] || [ "$API_KEYS" -gt 0 ]; then
            echo "ðŸš¨ Potential hardcoded secrets detected!"
            echo "Secrets found: $SECRETS"
            echo "API keys found: $API_KEYS"
            exit 1
          fi
          
          echo "âœ… No hardcoded secrets detected"
