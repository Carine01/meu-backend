name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite deploy manual via GitHub UI

env:
  PROJECT_ID: elevare-iara
  SERVICE_NAME: elevare-backend
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          set -e
          echo "Trying npm ci (fast, reproducible)..."
          if npm ci --no-audit --prefer-offline --progress=false; then
            echo "npm ci succeeded"
          else
            echo "npm ci failed - falling back to npm install"
            npm install --no-audit --progress=false
          fi
      
      - name: Run tests
        run: npm run test
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker to use gcloud as credential helper
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev
      
      - name: Build Docker image
        run: |
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$SERVICE_NAME/$SERVICE_NAME:$GITHUB_SHA -t $REGION-docker.pkg.dev/$PROJECT_ID/$SERVICE_NAME/$SERVICE_NAME:latest .
      
      - name: Create Artifact Registry repository if not exists
        run: |
          gcloud artifacts repositories create $SERVICE_NAME \
            --repository-format=docker \
            --location=$REGION \
            --description="Docker repository for $SERVICE_NAME" || echo "Repository already exists"
      
      - name: Push Docker image to Artifact Registry
        run: |
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$SERVICE_NAME/$SERVICE_NAME:$GITHUB_SHA
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$SERVICE_NAME/$SERVICE_NAME:latest
      
      - name: Delete existing service (force clean deploy)
        run: |
          gcloud run services delete $SERVICE_NAME \
            --region $REGION \
            --quiet || true
      
      - name: Setup Firebase Secret in Secret Manager
        run: |
          # Cria/atualiza o secret no GCP Secret Manager
          echo '${{ secrets.GCP_SA_KEY }}' | gcloud secrets create firebase-sa-key \
            --data-file=- \
            --replication-policy="automatic" \
            --project=$PROJECT_ID 2>/dev/null || \
          echo '${{ secrets.GCP_SA_KEY }}' | gcloud secrets versions add firebase-sa-key \
            --data-file=- \
            --project=$PROJECT_ID
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/$SERVICE_NAME/$SERVICE_NAME:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --max-instances 10 \
            --set-env-vars "NODE_ENV=production" \
            --set-secrets "FIREBASE_SERVICE_ACCOUNT_JSON=firebase-sa-key:latest"
