name: Elevare PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  elevare-validation:
    name: ğŸ¤– Elevare Agent - ValidaÃ§Ã£o Completa
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps

      - name: ğŸ”’ Secret Scanning
        id: secret-scan
        run: |
          echo "ğŸ” Verificando vazamento de segredos..."
          # Check for common secret patterns in the diff
          # This checks for: password=..., api_key=..., token=..., etc. with quoted values
          if git diff origin/main...HEAD | grep -i -E '(password|secret|api[_-]?key|token|bearer|private[_-]?key|aws[_-]?access|credential)[[:space:]]*[:=][[:space:]]*["\x27][^"\x27]{8,}["\x27]'; then
            echo "âŒ FALHA: PossÃ­vel vazamento de segredos detectado!"
            echo "has_secrets=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Nenhum segredo detectado"
            echo "has_secrets=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“˜ TypeScript Validation
        id: typescript
        run: |
          echo "ğŸ” Validando TypeScript..."
          npm run build 2>&1 | tee typescript-output.txt
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… TypeScript compilado sem erros"
            echo "ts_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ FALHA: Erros de TypeScript detectados"
            echo "ts_status=failure" >> $GITHUB_OUTPUT
            cat typescript-output.txt
            exit 1
          fi

      - name: ğŸ§ª Run Tests
        id: tests
        run: |
          echo "ğŸ” Executando testes..."
          npm run test -- --passWithNoTests 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          # Extract test results
          if grep -q "Tests:.*failed" test-output.txt; then
            FAILED=$(grep "Tests:" test-output.txt | sed -n 's/.*\([0-9]\+\) failed.*/\1/p')
            echo "âŒ FALHA: $FAILED teste(s) falharam"
            echo "test_status=failure" >> $GITHUB_OUTPUT
            echo "failed_tests=$FAILED" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Todos os testes passaram"
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "failed_tests=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Test Coverage
        id: coverage
        if: success() || failure()
        run: |
          echo "ğŸ” Analisando cobertura de testes..."
          npm run test:cov -- --passWithNoTests 2>&1 | tee coverage-output.txt || true
          
          if grep -q "Coverage" coverage-output.txt; then
            COVERAGE=$(grep -oP '\d+\.\d+(?=%)' coverage-output.txt | head -1)
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Cobertura: $COVERAGE%"
          fi

      - name: ğŸ” Check for Lint Config
        id: lint-check
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo "has_eslint=true" >> $GITHUB_OUTPUT
            echo "âœ… ConfiguraÃ§Ã£o ESLint encontrada"
          else
            echo "has_eslint=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Nenhuma configuraÃ§Ã£o ESLint encontrada"
          fi

      - name: ğŸ¨ Run ESLint (if available)
        id: eslint
        if: steps.lint-check.outputs.has_eslint == 'true'
        continue-on-error: true
        run: |
          echo "ğŸ” Executando ESLint..."
          npx eslint . --ext .ts,.js --max-warnings 0 2>&1 | tee eslint-output.txt
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… Nenhum erro de lint encontrado"
            echo "lint_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Erros de lint encontrados"
            echo "lint_status=failure" >> $GITHUB_OUTPUT
          fi

      - name: âš ï¸ Check for Critical Warnings
        id: warnings
        if: success() || failure()
        run: |
          echo "ğŸ” Verificando warnings crÃ­ticos..."
          WARNINGS=0
          
          # Check TypeScript warnings
          if [ -f "typescript-output.txt" ]; then
            TS_WARNINGS=$(grep -c "warning TS" typescript-output.txt || echo "0")
            WARNINGS=$((WARNINGS + TS_WARNINGS))
          fi
          
          echo "warnings_count=$WARNINGS" >> $GITHUB_OUTPUT
          
          if [ $WARNINGS -gt 0 ]; then
            echo "âš ï¸ $WARNINGS warning(s) crÃ­tico(s) encontrado(s)"
          else
            echo "âœ… Nenhum warning crÃ­tico"
          fi

      - name: ğŸ“ Generate Elevare Report
        if: always()
        run: |
          cat > elevare-report.md << 'EOF'
          ## ğŸ¤– Elevare Agent - RelatÃ³rio de ValidaÃ§Ã£o
          
          ### Status Geral
          
          | CritÃ©rio | Status | Detalhes |
          |----------|--------|----------|
          | ğŸ”’ Segredos | ${{ steps.secret-scan.outputs.has_secrets == 'false' && 'âœ… OK' || 'âŒ FALHA' }} | ${{ steps.secret-scan.outputs.has_secrets == 'false' && 'Nenhum segredo detectado' || 'Vazamento detectado!' }} |
          | ğŸ“˜ TypeScript | ${{ steps.typescript.outputs.ts_status == 'success' && 'âœ… OK' || 'âŒ FALHA' }} | ${{ steps.typescript.outputs.ts_status == 'success' && 'CompilaÃ§Ã£o limpa' || 'Erros de compilaÃ§Ã£o' }} |
          | ğŸ§ª Testes | ${{ steps.tests.outputs.test_status == 'success' && 'âœ… OK' || 'âŒ FALHA' }} | ${{ steps.tests.outputs.failed_tests || '0' }} teste(s) falharam |
          | ğŸ¨ Lint | ${{ steps.eslint.outputs.lint_status == 'success' && 'âœ… OK' || (steps.lint-check.outputs.has_eslint == 'false' && 'âš ï¸ N/A' || 'âŒ FALHA') }} | ${{ steps.lint-check.outputs.has_eslint == 'false' && 'ESLint nÃ£o configurado' || 'Verificado' }} |
          | âš ï¸ Warnings | ${{ steps.warnings.outputs.warnings_count == '0' && 'âœ… OK' || 'âš ï¸ ATENÃ‡ÃƒO' }} | ${{ steps.warnings.outputs.warnings_count || '0' }} warning(s) |
          
          ### ğŸ“Š Cobertura de Testes
          ${{ steps.coverage.outputs.coverage && format('**{0}%** de cobertura', steps.coverage.outputs.coverage) || 'Cobertura nÃ£o disponÃ­vel' }}
          
          ### ğŸ¯ DecisÃ£o do Agente
          
          EOF
          
          # Determine overall status
          if [ "${{ steps.secret-scan.outputs.has_secrets }}" == "true" ] || \
             [ "${{ steps.typescript.outputs.ts_status }}" == "failure" ] || \
             [ "${{ steps.tests.outputs.test_status }}" == "failure" ]; then
            cat >> elevare-report.md << 'EOF'
          âŒ **PR REJEITADO**
          
          Este PR nÃ£o atende aos critÃ©rios mÃ­nimos de qualidade do Agente Elevare.
          
          **AÃ§Ãµes necessÃ¡rias:**
          - Corrija todos os erros listados acima
          - Execute os testes localmente antes de fazer push
          - Verifique se nÃ£o hÃ¡ segredos no cÃ³digo
          
          **RevisÃ£o rigorosa aplicada** - O Agente Elevare trabalha como revisor senior: frio, direto e criterioso.
          EOF
            echo "pr_status=rejected" >> elevare-report.md
          else
            cat >> elevare-report.md << 'EOF'
          âœ… **PR APROVADO**
          
          Este PR atende aos critÃ©rios de qualidade do Agente Elevare.
          
          **PrÃ³ximos passos:**
          - Aguarde revisÃ£o humana se necessÃ¡rio
          - Pode ser mergeado apÃ³s aprovaÃ§Ã£o
          
          Bom trabalho! ğŸ‰
          EOF
            echo "pr_status=approved" >> elevare-report.md
          fi

      - name: ğŸ’¬ Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('elevare-report.md', 'utf8');
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¤– Elevare Agent')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: âŒ Fail if validation failed
        if: |
          steps.secret-scan.outputs.has_secrets == 'true' ||
          steps.typescript.outputs.ts_status == 'failure' ||
          steps.tests.outputs.test_status == 'failure'
        run: |
          echo "âŒ PR validation failed - see report above"
          exit 1

      - name: âœ… Validation Passed
        if: success()
        run: |
          echo "âœ… Todas as validaÃ§Ãµes passaram!"
          echo "âœ… Este PR estÃ¡ pronto para revisÃ£o humana"
