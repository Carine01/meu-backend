name: üì± WhatsApp Monitor

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch: # Manual trigger

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # Only run if API URL is configured
    if: github.repository == 'Carine01/meu-backend'
    
    steps:
      - name: üìä Check WhatsApp status
        id: check_status
        run: |
          # Check if API_URL is configured
          if [ -z "${{ secrets.API_URL }}" ]; then
            echo "‚ö†Ô∏è API_URL secret not configured"
            echo "‚ÑπÔ∏è Skipping WhatsApp status check"
            echo "üìù Configure API_URL secret to enable monitoring"
            exit 0
          fi
          
          API_URL="${{ secrets.API_URL }}"
          
          echo "üîç Checking WhatsApp status at $API_URL/whatsapp/status"
          
          # Try to get status (with timeout)
          RESPONSE=$(curl -s --max-time 10 "$API_URL/whatsapp/status" || echo '{"connected":false}')
          
          echo "Response: $RESPONSE"
          
          # Extract connected status
          CONNECTED=$(echo "$RESPONSE" | jq -r '.connected // false' 2>/dev/null || echo "false")
          
          echo "connected=$CONNECTED" >> $GITHUB_OUTPUT
          
          if [ "$CONNECTED" != "true" ]; then
            echo "üö® WhatsApp is disconnected!"
            exit 1
          fi
          
          echo "‚úÖ WhatsApp is connected"
      
      - name: üîî Send Discord alert
        if: failure() && secrets.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"@here üö® WhatsApp desconectado! Verifica√ß√£o necess√°ria.\",\"username\":\"WhatsApp Monitor\"}"
      
      - name: üìä Send Slack alert
        if: failure() && secrets.SLACK_WEBHOOK != ''
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"üö® WhatsApp Monitor Alert: Connection lost! Please check the service.\"}"
      
      - name: ‚ÑπÔ∏è Monitor status
        if: success()
        run: |
          echo "‚úÖ WhatsApp connection is healthy"
          
      - name: ‚ÑπÔ∏è Configuration info
        if: always() && secrets.API_URL == ''
        run: |
          echo "‚ÑπÔ∏è WhatsApp monitoring requires configuration"
          echo "üìù To enable monitoring, configure these secrets in repository settings:"
          echo "  - API_URL (required): Your API base URL (e.g., https://api.example.com)"
          echo "  - DISCORD_WEBHOOK (optional): For Discord alerts"
          echo "  - SLACK_WEBHOOK (optional): For Slack alerts"
