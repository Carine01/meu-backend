name: Bug Hunter Elevare

on:
  push:
  schedule:
    - cron: "0 */2 * * *"  # A cada 2 horas

jobs:
  bug-hunter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Instalar depend√™ncias
        run: npm ci

      - name: Rodar an√°lise est√°tica
        run: |
          npx eslint . -f json -o eslint-report.json || true

      - name: Criar issue para cada erro encontrado
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Verifica se o arquivo de relat√≥rio existe e tem conte√∫do
          if [[ ! -f eslint-report.json ]] || [[ ! -s eslint-report.json ]]; then
            echo "Nenhum relat√≥rio ESLint encontrado ou arquivo vazio"
            exit 0
          fi
          
          # Conta o n√∫mero de arquivos com erros
          ERROR_COUNT=$(jq '[.[] | select(.errorCount > 0)] | length' eslint-report.json)
          
          if [[ "$ERROR_COUNT" -gt 0 ]]; then
            echo "Encontrados erros em $ERROR_COUNT arquivo(s)"
            
            # Cria um resumo dos erros
            SUMMARY=$(jq -r '[.[] | select(.errorCount > 0) | {file: .filePath, errors: .errorCount, warnings: .warningCount}] | 
              "## Resumo de Erros ESLint\n\nTotal de arquivos com erros: " + (length | tostring) + "\n\n" +
              (map("- **" + (.file | split("/") | last) + "**: " + (.errors | tostring) + " erro(s), " + (.warnings | tostring) + " aviso(s)") | join("\n"))' eslint-report.json)
            
            # Verifica se j√° existe uma issue aberta com o mesmo t√≠tulo
            EXISTING_ISSUE=$(gh issue list --label "bug-hunter" --state open --limit 1 --json number --jq '.[0].number' || echo "")
            
            if [[ -n "$EXISTING_ISSUE" ]]; then
              echo "Issue #$EXISTING_ISSUE j√° existe. Atualizando com novo coment√°rio..."
              gh issue comment "$EXISTING_ISSUE" --body "$SUMMARY"
            else
              echo "Criando nova issue..."
              gh issue create \
                --title "üîç Bug Hunter: Erros detectados automaticamente" \
                --label "bug-hunter,automated" \
                --body "$SUMMARY"
            fi
          else
            echo "Nenhum erro encontrado! üéâ"
          fi
