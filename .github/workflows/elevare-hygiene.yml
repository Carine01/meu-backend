name: Elevare - HigienizaÃ§Ã£o

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  hygiene-check:
    name: VerificaÃ§Ã£o de Higiene
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps
      
      - name: Check for orphaned files
        id: orphaned
        run: |
          echo "## ðŸ“ VerificaÃ§Ã£o de Arquivos Ã“rfÃ£os" >> $GITHUB_STEP_SUMMARY
          
          # Find TypeScript files not imported anywhere
          ORPHANED=0
          
          find src -name "*.ts" -not -name "*.spec.ts" -not -name "*.test.ts" > all-ts-files.txt
          
          while IFS= read -r file; do
            filename=$(basename "$file" .ts)
            # Check if file is imported anywhere
            if ! grep -r "from.*$filename" --include="*.ts" src/ > /dev/null 2>&1 && \
               ! grep -r "import.*$filename" --include="*.ts" src/ > /dev/null 2>&1; then
              # Check if it's not main.ts or a module file
              if [[ ! "$file" =~ main.ts$ ]] && [[ ! "$file" =~ module.ts$ ]]; then
                echo "$file" >> orphaned-files.txt
                ORPHANED=$((ORPHANED + 1))
              fi
            fi
          done < all-ts-files.txt
          
          echo "orphaned=$ORPHANED" >> $GITHUB_OUTPUT
          
          if [ "$ORPHANED" -gt 0 ]; then
            echo "âš ï¸ Arquivos possivelmente Ã³rfÃ£os detectados: $ORPHANED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Lista de arquivos:" >> $GITHUB_STEP_SUMMARY
            head -20 orphaned-files.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Nenhum arquivo Ã³rfÃ£o detectado" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for unused dependencies
        id: unused-deps
        run: |
          echo "## ðŸ“¦ DependÃªncias NÃ£o Usadas" >> $GITHUB_STEP_SUMMARY
          
          npx depcheck --json > depcheck-full.json 2>&1 || true
          
          if [ -f depcheck-full.json ]; then
            # Extract unused dependencies
            UNUSED=$(cat depcheck-full.json | grep -o '"dependencies":\[.*\]' || echo '[]')
            
            if echo "$UNUSED" | grep -q "\["; then
              COUNT=$(echo "$UNUSED" | grep -o "," | wc -l)
              COUNT=$((COUNT + 1))
              
              if [ "$COUNT" -gt 1 ]; then
                echo "âš ï¸ DependÃªncias nÃ£o usadas: $COUNT" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```json' >> $GITHUB_STEP_SUMMARY
                cat depcheck-full.json | grep -A 20 '"dependencies"' | head -25 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "status=warning" >> $GITHUB_OUTPUT
                echo "count=$COUNT" >> $GITHUB_OUTPUT
              else
                echo "âœ… Nenhuma dependÃªncia nÃ£o usada" >> $GITHUB_STEP_SUMMARY
                echo "status=success" >> $GITHUB_OUTPUT
                echo "count=0" >> $GITHUB_OUTPUT
              fi
            else
              echo "âœ… Nenhuma dependÃªncia nÃ£o usada" >> $GITHUB_STEP_SUMMARY
              echo "status=success" >> $GITHUB_OUTPUT
              echo "count=0" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Check for TypeScript warnings
        id: ts-warnings
        run: |
          echo "## âš ï¸ Avisos TypeScript" >> $GITHUB_STEP_SUMMARY
          
          npx tsc --noEmit 2>&1 | tee tsc-warnings.log || true
          
          WARNINGS=$(grep -c "warning TS" tsc-warnings.log || echo "0")
          ERRORS=$(grep -c "error TS" tsc-warnings.log || echo "0")
          
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "âŒ Erros TypeScript: $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            head -30 tsc-warnings.log >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
          elif [ "$WARNINGS" -gt 0 ]; then
            echo "âš ï¸ Avisos TypeScript: $WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Sem avisos ou erros TypeScript" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for broken imports
        id: broken-imports
        run: |
          echo "## ðŸ”— VerificaÃ§Ã£o de Imports Quebrados" >> $GITHUB_STEP_SUMMARY
          
          BROKEN=0
          
          # Look for common import issues
          if grep -r "from '\.\./\.\./\.\./\.\./\.\." --include="*.ts" src/ > broken-imports.txt 2>&1; then
            BROKEN=$(wc -l < broken-imports.txt)
          fi
          
          echo "broken=$BROKEN" >> $GITHUB_OUTPUT
          
          if [ "$BROKEN" -gt 0 ]; then
            echo "âš ï¸ Imports com paths muito longos (possÃ­vel problema): $BROKEN" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            head -10 broken-imports.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Nenhum import suspeito detectado" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for duplicate code
        id: duplicates
        continue-on-error: true
        run: |
          echo "## ðŸ”„ VerificaÃ§Ã£o de CÃ³digo Duplicado" >> $GITHUB_STEP_SUMMARY
          
          # Simple duplicate detection - look for identical function signatures
          find src -name "*.ts" -not -name "*.spec.ts" -exec grep -h "^\s*function\|^\s*const.*=.*=>" {} \; | sort | uniq -d > duplicates.txt 2>/dev/null || true
          
          DUPS=0
          if [ -f duplicates.txt ]; then
            DUPS=$(wc -l < duplicates.txt)
          fi
          
          echo "duplicates=$DUPS" >> $GITHUB_OUTPUT
          
          if [ "$DUPS" -gt 5 ]; then
            echo "âš ï¸ PossÃ­vel cÃ³digo duplicado detectado: $DUPS ocorrÃªncias" >> $GITHUB_STEP_SUMMARY
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… NÃ­vel aceitÃ¡vel de duplicaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for TODO/FIXME comments
        id: todos
        run: |
          echo "## ðŸ“ TODOs e FIXMEs" >> $GITHUB_STEP_SUMMARY
          
          TODOS=$(grep -r "TODO\|FIXME\|HACK" --include="*.ts" --include="*.js" src/ | wc -l || echo "0")
          
          echo "todos=$TODOS" >> $GITHUB_OUTPUT
          
          if [ "$TODOS" -gt 20 ]; then
            echo "âš ï¸ TODOs/FIXMEs encontrados: $TODOS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Primeiros 10:" >> $GITHUB_STEP_SUMMARY
            grep -r "TODO\|FIXME\|HACK" --include="*.ts" --include="*.js" src/ | head -10 >> $GITHUB_STEP_SUMMARY
            echo "status=warning" >> $GITHUB_OUTPUT
          elif [ "$TODOS" -gt 0 ]; then
            echo "â„¹ï¸ TODOs/FIXMEs: $TODOS (aceitÃ¡vel)" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âœ… Nenhum TODO/FIXME pendente" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Hygiene Report
        if: always()
        run: |
          cat > HYGIENE_REPORT.md << 'EOF'
          # RelatÃ³rio de HigienizaÃ§Ã£o Elevare
          
          **Data:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## Resultado das VerificaÃ§Ãµes
          
          | Check | Status | Detalhes |
          |-------|--------|----------|
          | Arquivos Ã“rfÃ£os | ${{ steps.orphaned.outputs.status }} | Detectados: ${{ steps.orphaned.outputs.orphaned || '0' }} |
          | DependÃªncias NÃ£o Usadas | ${{ steps.unused-deps.outputs.status }} | Count: ${{ steps.unused-deps.outputs.count || '0' }} |
          | Avisos TypeScript | ${{ steps.ts-warnings.outputs.status }} | Warnings: ${{ steps.ts-warnings.outputs.warnings || '0' }}, Errors: ${{ steps.ts-warnings.outputs.errors || '0' }} |
          | Imports Quebrados | ${{ steps.broken-imports.outputs.status }} | Encontrados: ${{ steps.broken-imports.outputs.broken || '0' }} |
          | CÃ³digo Duplicado | ${{ steps.duplicates.outputs.status }} | OcorrÃªncias: ${{ steps.duplicates.outputs.duplicates || '0' }} |
          | TODOs/FIXMEs | ${{ steps.todos.outputs.status }} | Total: ${{ steps.todos.outputs.todos || '0' }} |
          
          ## RecomendaÃ§Ãµes
          
          EOF
          
          if [ "${{ steps.orphaned.outputs.status }}" = "warning" ]; then
            echo "- ðŸ§¹ Remover ou usar arquivos Ã³rfÃ£os detectados" >> HYGIENE_REPORT.md
          fi
          
          if [ "${{ steps.unused-deps.outputs.status }}" = "warning" ]; then
            echo "- ðŸ“¦ Remover dependÃªncias nÃ£o utilizadas" >> HYGIENE_REPORT.md
          fi
          
          if [ "${{ steps.ts-warnings.outputs.status }}" != "success" ]; then
            echo "- âš ï¸ Corrigir avisos/erros TypeScript" >> HYGIENE_REPORT.md
          fi
          
          if [ "${{ steps.broken-imports.outputs.status }}" = "warning" ]; then
            echo "- ðŸ”— Refatorar imports com paths muito longos" >> HYGIENE_REPORT.md
          fi
          
          if [ "${{ steps.duplicates.outputs.status }}" = "warning" ]; then
            echo "- ðŸ”„ Refatorar cÃ³digo duplicado" >> HYGIENE_REPORT.md
          fi
          
          cat HYGIENE_REPORT.md >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Hygiene Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hygiene-report-${{ github.sha }}
          path: |
            HYGIENE_REPORT.md
            orphaned-files.txt
            depcheck-full.json
            tsc-warnings.log
            broken-imports.txt
            duplicates.txt
          retention-days: 30
