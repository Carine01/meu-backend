name: Agent Orchestrator - run agent scripts in sequence (robust)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run agents on'
        required: true
        default: 'main'
      skip_docker:
        description: 'Skip Docker build (faster)'
        required: false
        default: 'false'

jobs:
  orchestrate-agents:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --no-audit --prefer-offline
      
      - name: Agent 1 - TypeScript Guardian
        id: typescript-guardian
        run: |
          echo "üîç Running TypeScript Guardian..."
          npm run build && echo "‚úÖ TypeScript Guardian passed" || {
            echo "‚ùå TypeScript Guardian failed"
            echo "typescript_status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "typescript_status=success" >> $GITHUB_OUTPUT
      
      - name: Agent 2 - Register Fila Fallback
        id: fila-fallback
        if: always()
        run: |
          echo "üìã Running Register Fila Fallback..."
          if [ -f "scripts/register-fallback.sh" ]; then
            bash scripts/register-fallback.sh || echo "Fallback script completed with warnings"
          fi
          npm test -- --testPathPattern=fila --passWithNoTests || echo "No fila tests"
          echo "‚úÖ Register Fila Fallback completed"
          echo "fila_status=success" >> $GITHUB_OUTPUT
      
      - name: Agent 3 - WhatsApp Monitor
        id: whatsapp-monitor
        if: always()
        run: |
          echo "üì± Running WhatsApp Monitor..."
          npm test -- --testPathPattern=whatsapp --passWithNoTests || echo "No WhatsApp tests"
          echo "‚úÖ WhatsApp Monitor completed"
          echo "whatsapp_status=success" >> $GITHUB_OUTPUT
      
      - name: Agent 4 - Docker Builder
        id: docker-builder
        if: always() && github.event.inputs.skip_docker != 'true'
        run: |
          echo "üê≥ Running Docker Builder..."
          docker build -t test-image:latest . && echo "‚úÖ Docker build passed" || {
            echo "‚ùå Docker build failed"
            echo "docker_status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "docker_status=success" >> $GITHUB_OUTPUT
      
      - name: Generate summary report
        if: always()
        run: |
          echo "## ü§ñ Agent Orchestrator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch || github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Agent Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # TypeScript Guardian
          if [ "${{ steps.typescript-guardian.outputs.typescript_status }}" = "success" ]; then
            echo "- ‚úÖ **TypeScript Guardian**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **TypeScript Guardian**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fila Fallback
          if [ "${{ steps.fila-fallback.outputs.fila_status }}" = "success" ]; then
            echo "- ‚úÖ **Register Fila Fallback**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è  **Register Fila Fallback**: Completed with warnings" >> $GITHUB_STEP_SUMMARY
          fi
          
          # WhatsApp Monitor
          if [ "${{ steps.whatsapp-monitor.outputs.whatsapp_status }}" = "success" ]; then
            echo "- ‚úÖ **WhatsApp Monitor**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è  **WhatsApp Monitor**: Completed with warnings" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Docker Builder
          if [ "${{ github.event.inputs.skip_docker }}" = "true" ]; then
            echo "- ‚è≠Ô∏è  **Docker Builder**: Skipped" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.docker-builder.outputs.docker_status }}" = "success" ]; then
            echo "- ‚úÖ **Docker Builder**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå **Docker Builder**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail job if critical agents failed
        if: steps.typescript-guardian.outputs.typescript_status == 'failed' || steps.docker-builder.outputs.docker_status == 'failed'
        run: |
          echo "‚ùå Critical agents failed. Failing the job."
          exit 1
