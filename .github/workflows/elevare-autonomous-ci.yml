name: Elevare Autonomous CI/CD

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  merge_group:
  release:
    types: [published, created, edited]
  schedule:
    # Executa todos os dias Ã s 3h AM (UTC) para manutenÃ§Ã£o contÃ­nua
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment step'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  ARTIFACT_DIR: 'artifacts'

jobs:
  # JOB 1: AUTO FIX E VALIDAÃ‡ÃƒO INICIAL
  auto-fix:
    name: ðŸ”§ Auto Fix & Initial Validation
    runs-on: ubuntu-latest
    outputs:
      has_fixes: ${{ steps.check_changes.outputs.has_changes }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Run Elevare Auto Fix
        id: run_autofix
        run: |
          bash scripts/elevare_auto_fix.sh
          
      - name: Check for changes
        id: check_changes
        run: |
          git diff --exit-code || echo "has_changes=true" >> $GITHUB_OUTPUT
          
      - name: Create artifacts directory
        run: mkdir -p ${{ env.ARTIFACT_DIR }}
        
      - name: Upload auto-fix report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autofix-report
          path: /tmp/elevare_autofix_report.txt
          retention-days: 30

  # JOB 2: BUILD
  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          if npm ci --silent; then
            echo "âœ“ npm ci succeeded"
          else
            echo "âš  npm ci failed, trying npm install"
            npm install --silent
          fi
          
      - name: Build TypeScript
        run: |
          npm run build
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: dist/
          retention-days: 7

  # JOB 3: LINT & TYPE CHECK
  lint-typecheck:
    name: ðŸŽ¨ Lint & TypeCheck
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --silent || npm install --silent
        
      - name: TypeScript Check
        id: typecheck
        run: |
          if npx tsc --noEmit; then
            echo "TypeScript check passed"
          else
            echo "TYPECHECK_FAILED=true" >> $GITHUB_ENV
            echo "TypeScript errors detected - job will continue but marked as warning"
          fi
          
      - name: ESLint Check (if configured)
        continue-on-error: true
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            npx eslint "src/**/*.ts" || echo "ESLint issues found"
          else
            echo "ESLint not configured, skipping"
          fi
          
      - name: Prettier Check (if configured)
        continue-on-error: true
        run: |
          if [ -f ".prettierrc" ] || [ -f "prettier.config.js" ]; then
            npx prettier --check "src/**/*.ts" || echo "Prettier issues found"
          else
            echo "Prettier not configured, skipping"
          fi

  # JOB 4: TESTS
  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --silent || npm install --silent
        
      - name: Run unit tests
        run: |
          npm run test -- --ci --coverage --maxWorkers=2
          
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # JOB 5: SECURITY SCAN
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: auto-fix
    permissions:
      security-events: write
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --silent || npm install --silent
        
      - name: Run npm audit
        continue-on-error: true
        run: |
          npm audit --production --audit-level=high --json > npm-audit.json || true
          cat npm-audit.json
          
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            npm-audit.json
          retention-days: 30

  # JOB 6: DEPENDENCY CHECK
  dependency-check:
    name: ðŸ“¦ Dependency Check
    runs-on: ubuntu-latest
    needs: auto-fix
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --silent || npm install --silent
        
      - name: Check for unused dependencies
        continue-on-error: true
        run: |
          npx depcheck --json > depcheck-report.json || true
          cat depcheck-report.json
          
      - name: Check for outdated dependencies
        continue-on-error: true
        run: |
          npm outdated --json > outdated-report.json || true
          cat outdated-report.json
          
      - name: Upload dependency reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            depcheck-report.json
            outdated-report.json
          retention-days: 30

  # JOB 7: GENERATE REPORT
  generate-report:
    name: ðŸ“Š Generate Technical Report
    runs-on: ubuntu-latest
    needs: [build, lint-typecheck, test, security, dependency-check]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts-download/
          
      - name: Create artifacts directory
        run: mkdir -p ${{ env.ARTIFACT_DIR }}
        
      - name: Generate comprehensive report
        run: |
          cat > ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md << 'EOF'
          # ðŸš€ ELEVARE CI/CD - RELATÃ“RIO TÃ‰CNICO
          
          **Data:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Triggered by:** ${{ github.event_name }}
          
          ---
          
          ## ðŸ“‹ RESUMO EXECUTIVO
          
          | Etapa | Status | Detalhes |
          |-------|--------|----------|
          | ðŸ”§ Auto Fix | ${{ needs.auto-fix.result }} | CorreÃ§Ãµes automÃ¡ticas aplicadas |
          | ðŸ”¨ Build | ${{ needs.build.result }} | CompilaÃ§Ã£o TypeScript |
          | ðŸŽ¨ Lint/TypeCheck | ${{ needs.lint-typecheck.result }} | ValidaÃ§Ã£o de cÃ³digo |
          | ðŸ§ª Tests | ${{ needs.test.result }} | Testes unitÃ¡rios |
          | ðŸ”’ Security | ${{ needs.security.result }} | AnÃ¡lise de seguranÃ§a |
          | ðŸ“¦ Dependencies | ${{ needs.dependency-check.result }} | VerificaÃ§Ã£o de dependÃªncias |
          
          ---
          
          ## ðŸ”§ AUTO FIX
          
          Script **elevare_auto_fix.sh** executado com sucesso.
          
          **AÃ§Ãµes realizadas:**
          - âœ“ DependÃªncias verificadas e instaladas
          - âœ“ Vulnerabilidades verificadas
          - âœ“ Build anterior limpo
          - âœ“ TypeScript validado
          - âœ“ FormataÃ§Ã£o aplicada
          - âœ“ Arquivos temporÃ¡rios removidos
          
          ---
          
          ## ðŸ”¨ BUILD
          
          **Status:** ${{ needs.build.result }}
          
          Build TypeScript concluÃ­do. Artefatos gerados em `dist/`.
          
          ---
          
          ## ðŸŽ¨ LINT & TYPECHECK
          
          **Status:** ${{ needs.lint-typecheck.result }}
          
          - TypeScript compilation check
          - ESLint validation (if configured)
          - Prettier formatting check (if configured)
          
          ---
          
          ## ðŸ§ª TESTES
          
          **Status:** ${{ needs.test.result }}
          
          Testes unitÃ¡rios executados com cobertura de cÃ³digo.
          RelatÃ³rio de cobertura disponÃ­vel nos artefatos.
          
          ---
          
          ## ðŸ”’ SEGURANÃ‡A
          
          **Status:** ${{ needs.security.result }}
          
          **AnÃ¡lises realizadas:**
          - npm audit (vulnerabilidades de dependÃªncias)
          - CodeQL (anÃ¡lise estÃ¡tica de seguranÃ§a)
          
          **RecomendaÃ§Ãµes:**
          - Revisar vulnerabilidades encontradas no npm audit
          - Verificar alertas do CodeQL no Security tab
          
          ---
          
          ## ðŸ“¦ DEPENDÃŠNCIAS
          
          **Status:** ${{ needs.dependency-check.result }}
          
          **VerificaÃ§Ãµes:**
          - DependÃªncias nÃ£o utilizadas (depcheck)
          - DependÃªncias desatualizadas (npm outdated)
          
          ---
          
          ## âš ï¸ AÃ‡Ã•ES NECESSÃRIAS
          
          EOF
          
          # Add conditional actions based on results
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "- âŒ **Build falhou** - Corrigir erros de compilaÃ§Ã£o TypeScript" >> ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md
          fi
          
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "- âŒ **Testes falharam** - Investigar e corrigir testes quebrados" >> ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md
          fi
          
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "- âš ï¸ **Problemas de seguranÃ§a detectados** - Revisar relatÃ³rio de seguranÃ§a" >> ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md
          fi
          
          cat >> ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md << 'EOF'
          
          ---
          
          ## ðŸš€ PRÃ“XIMOS PASSOS
          
          1. Revisar este relatÃ³rio
          2. Corrigir problemas identificados
          3. Verificar artefatos gerados
          4. Aprovar deploy (se aplicÃ¡vel)
          
          ---
          
          **Gerado automaticamente pelo Elevare Autonomous CI/CD**
          EOF
          
      - name: Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: elevare-ci-report
          path: ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md
          retention-days: 90
          
      - name: Display report summary
        run: |
          echo "ðŸ“Š RelatÃ³rio gerado em: ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md"
          cat ${{ env.ARTIFACT_DIR }}/ELEVARE_CI_REPORT.md

  # JOB 8: CREATE AUTO-FIX PR (if fixes were applied)
  create-fix-pr:
    name: ðŸ”„ Create Auto-Fix PR
    runs-on: ubuntu-latest
    needs: [auto-fix, generate-report]
    if: needs.auto-fix.outputs.has_fixes == 'true' && github.event_name != 'pull_request'
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Git
        run: |
          git config --global user.name "elevare-ci-bot"
          git config --global user.email "elevare-ci-bot@users.noreply.github.com"
          
      - name: Create fix branch and PR
        run: |
          BRANCH_NAME="auto-fix/elevare-ci-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "chore: automatic fixes from Elevare CI/CD" || exit 0
          git push origin $BRANCH_NAME
          
          gh pr create \
            --title "ðŸ”§ Elevare CI/CD: Automatic Fixes" \
            --body "## CorreÃ§Ãµes AutomÃ¡ticas Aplicadas

          Este PR foi criado automaticamente pelo Elevare CI/CD.

          **CorreÃ§Ãµes incluÃ­das:**
          - DependÃªncias atualizadas
          - Vulnerabilidades corrigidas (quando possÃ­vel)
          - FormataÃ§Ã£o de cÃ³digo aplicada
          - Limpeza de arquivos temporÃ¡rios

          **Revisar:**
          - Verificar se todas as mudanÃ§as sÃ£o apropriadas
          - Executar testes localmente se necessÃ¡rio
          - Fazer merge se tudo estiver OK

          ---
          *Gerado automaticamente em: $(date)*" \
            --label "automated,ci-fix" \
            --base main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # JOB 9: CREATE ISSUE ON FAILURE
  create-failure-issue:
    name: ðŸš¨ Create Issue on Failure
    runs-on: ubuntu-latest
    needs: [build, lint-typecheck, test, security]
    if: |
      failure() && 
      github.event_name != 'pull_request' &&
      (needs.build.result == 'failure' || needs.test.result == 'failure')
    permissions:
      issues: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create failure issue
        run: |
          gh issue create \
            --title "ðŸš¨ CI/CD Failure: ${{ github.ref_name }} - $(date +%Y-%m-%d)" \
            --body "## âš ï¸ Falha no CI/CD Pipeline

          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Triggered by:** ${{ github.event_name }}

          ### Falhas Detectadas

          | Job | Status |
          |-----|--------|
          | Build | ${{ needs.build.result }} |
          | Lint/TypeCheck | ${{ needs.lint-typecheck.result }} |
          | Tests | ${{ needs.test.result }} |
          | Security | ${{ needs.security.result }} |

          ### AÃ§Ãµes NecessÃ¡rias

          1. Revisar logs do workflow
          2. Corrigir problemas identificados
          3. Executar CI localmente antes de push
          4. Reexecutar workflow apÃ³s correÃ§Ãµes

          ### Links Ãšteis

          - [Ver logs completos](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Comparar mudanÃ§as](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          ---
          *Issue criada automaticamente pelo Elevare CI/CD*" \
            --label "bug,ci-failure,priority-high" \
            --assignee ${{ github.actor }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # JOB 10: DEPLOY (with risk checks)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [build, lint-typecheck, test, security, generate-report]
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push' &&
      needs.build.result == 'success' &&
      needs.test.result == 'success' &&
      inputs.skip_deploy != true
    permissions:
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Risk Assessment
        id: risk_check
        run: |
          RISK_LEVEL="low"
          DEPLOY_BLOCKED=false
          
          # Check for security failures
          if [ "${{ needs.security.result }}" != "success" ]; then
            RISK_LEVEL="high"
            DEPLOY_BLOCKED=true
            echo "âš ï¸ Security check failed - blocking deploy"
          fi
          
          # Check for lint/typecheck failures
          if [ "${{ needs.lint-typecheck.result }}" != "success" ]; then
            RISK_LEVEL="medium"
            echo "âš ï¸ Lint/TypeCheck has issues"
          fi
          
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "deploy_blocked=$DEPLOY_BLOCKED" >> $GITHUB_OUTPUT
          
          if [ "$DEPLOY_BLOCKED" = "true" ]; then
            echo "ðŸš« DEPLOY BLOQUEADO devido a riscos de seguranÃ§a!"
            exit 1
          fi
          
      - name: Deploy notification
        if: steps.risk_check.outputs.deploy_blocked != 'true'
        run: |
          echo "âœ… Todos os checks passaram - deploy aprovado"
          echo "ðŸ“Š NÃ­vel de risco: ${{ steps.risk_check.outputs.risk_level }}"
          echo "ðŸš€ Iniciando deploy..."
          
      # Aqui vocÃª pode adicionar seus steps de deploy especÃ­ficos
      # Por exemplo, deploy para Cloud Run, Heroku, etc.
      - name: Deploy to production
        if: steps.risk_check.outputs.deploy_blocked != 'true'
        run: |
          echo "Deploy step - configure according to your infrastructure"
          echo "Example: gcloud run deploy, kubectl apply, etc."

  # JOB 11: CLEANUP (scheduled maintenance)
  cleanup:
    name: ðŸ§¹ Cleanup & Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Clean old dependencies
        run: |
          echo "ðŸ§¹ Limpando cache e dependÃªncias antigas..."
          rm -rf node_modules
          npm cache clean --force
          
      - name: Update dependencies (patch versions)
        run: |
          npm update --save
          
      - name: Check for major updates
        continue-on-error: true
        run: |
          npm outdated
          
      - name: Create maintenance report
        run: |
          cat > maintenance-report.md << EOF
          # RelatÃ³rio de ManutenÃ§Ã£o - $(date)
          
          ## AÃ§Ãµes Realizadas
          - Cache limpo
          - DependÃªncias patch atualizadas
          - VerificaÃ§Ã£o de updates maiores realizada
          
          ## PrÃ³ximas AÃ§Ãµes Recomendadas
          - Revisar dependÃªncias desatualizadas
          - Considerar atualizaÃ§Ã£o de versÃµes maiores
          - Verificar breaking changes
          EOF
          
      - name: Upload maintenance report
        uses: actions/upload-artifact@v4
        with:
          name: maintenance-report
          path: maintenance-report.md
          retention-days: 90
