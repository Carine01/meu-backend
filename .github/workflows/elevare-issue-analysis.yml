name: Elevare Issue Analysis

on:
  issues:
    types: [opened, labeled]
  schedule:
    # Runs daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  analyze-issues:
    name: ğŸ” AnÃ¡lise de Issues e Agrupamento
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Analyze and Group Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸ” Iniciando anÃ¡lise de issues...');
            
            // Get all open issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`ğŸ“‹ Total de issues abertas: ${issues.data.length}`);
            
            // Group issues by type
            const bugIssues = [];
            const featureIssues = [];
            const testIssues = [];
            const securityIssues = [];
            const dependencyIssues = [];
            const documentationIssues = [];
            const otherIssues = [];
            
            for (const issue of issues.data) {
              if (issue.pull_request) continue; // Skip PRs
              
              const labels = issue.labels.map(l => l.name.toLowerCase());
              
              if (labels.some(l => l.includes('bug') || l.includes('erro'))) {
                bugIssues.push(issue);
              } else if (labels.some(l => l.includes('security') || l.includes('seguranÃ§a'))) {
                securityIssues.push(issue);
              } else if (labels.some(l => l.includes('test') || l.includes('teste'))) {
                testIssues.push(issue);
              } else if (labels.some(l => l.includes('dependencies') || l.includes('dependÃªncia'))) {
                dependencyIssues.push(issue);
              } else if (labels.some(l => l.includes('documentation') || l.includes('docs'))) {
                documentationIssues.push(issue);
              } else if (labels.some(l => l.includes('feature') || l.includes('enhancement'))) {
                featureIssues.push(issue);
              } else {
                otherIssues.push(issue);
              }
            }
            
            // Create summary
            const summary = `
            ## ğŸ” AnÃ¡lise de Issues - ${new Date().toISOString().split('T')[0]}
            
            ### ğŸ“Š Resumo por Categoria
            
            | Categoria | Quantidade | Issues |
            |-----------|------------|---------|
            | ğŸ› Bugs | ${bugIssues.length} | ${bugIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${bugIssues.length > 5 ? '...' : ''} |
            | ğŸ”’ SeguranÃ§a | ${securityIssues.length} | ${securityIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${securityIssues.length > 5 ? '...' : ''} |
            | ğŸ§ª Testes | ${testIssues.length} | ${testIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${testIssues.length > 5 ? '...' : ''} |
            | ğŸ“¦ DependÃªncias | ${dependencyIssues.length} | ${dependencyIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${dependencyIssues.length > 5 ? '...' : ''} |
            | ğŸ“ DocumentaÃ§Ã£o | ${documentationIssues.length} | ${documentationIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${documentationIssues.length > 5 ? '...' : ''} |
            | âœ¨ Features | ${featureIssues.length} | ${featureIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${featureIssues.length > 5 ? '...' : ''} |
            | ğŸ“‹ Outras | ${otherIssues.length} | ${otherIssues.slice(0, 5).map(i => `#${i.number}`).join(', ')}${otherIssues.length > 5 ? '...' : ''} |
            
            ### ğŸ¯ Prioridades Recomendadas
            
            `;
            
            console.log(summary);
            
            // Auto-label issues without labels
            let labeledCount = 0;
            for (const issue of issues.data) {
              if (issue.pull_request) continue;
              if (issue.labels.length > 0) continue;
              
              const title = issue.title.toLowerCase();
              const body = (issue.body || '').toLowerCase();
              
              const labels = [];
              
              // Auto-detect issue type based on title and body
              if (title.includes('bug') || title.includes('erro') || title.includes('error')) {
                labels.push('bug');
              }
              if (title.includes('test') || title.includes('teste')) {
                labels.push('teste');
              }
              if (title.includes('doc') || body.includes('documentaÃ§Ã£o')) {
                labels.push('documentation');
              }
              if (title.includes('security') || title.includes('seguranÃ§a') || body.includes('vulnerab')) {
                labels.push('security');
              }
              if (title.includes('feature') || title.includes('adicionar') || title.includes('novo')) {
                labels.push('enhancement');
              }
              
              // Add priority labels based on keywords
              if (title.includes('critical') || title.includes('crÃ­tico') || title.includes('urgente')) {
                labels.push('high-priority');
              }
              
              if (labels.length > 0) {
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: labels
                  });
                  labeledCount++;
                  console.log(`âœ… Issue #${issue.number} auto-labelada: ${labels.join(', ')}`);
                } catch (error) {
                  console.log(`âš ï¸ Erro ao labelar issue #${issue.number}: ${error.message}`);
                }
              }
            }
            
            console.log(`âœ… ${labeledCount} issues auto-labeladas`);
            
            // Identify potential root causes
            const rootCauses = new Map();
            
            // Analyze bug patterns
            for (const bug of bugIssues) {
              const title = bug.title.toLowerCase();
              const body = (bug.body || '').toLowerCase();
              
              // Detect common patterns
              if (title.includes('typescript') || body.includes('typescript')) {
                rootCauses.set('TypeScript', (rootCauses.get('TypeScript') || 0) + 1);
              }
              if (title.includes('test') || body.includes('test fail')) {
                rootCauses.set('Testes', (rootCauses.get('Testes') || 0) + 1);
              }
              if (title.includes('dependenc') || body.includes('package')) {
                rootCauses.set('DependÃªncias', (rootCauses.get('DependÃªncias') || 0) + 1);
              }
              if (title.includes('auth') || body.includes('autenticaÃ§Ã£o')) {
                rootCauses.set('AutenticaÃ§Ã£o', (rootCauses.get('AutenticaÃ§Ã£o') || 0) + 1);
              }
              if (title.includes('database') || title.includes('db') || body.includes('typeorm')) {
                rootCauses.set('Database', (rootCauses.get('Database') || 0) + 1);
              }
            }
            
            if (rootCauses.size > 0) {
              console.log('\n### ğŸ¯ Causas RaÃ­zes Identificadas:');
              for (const [cause, count] of rootCauses.entries()) {
                console.log(`- ${cause}: ${count} issue(s)`);
              }
            }

      - name: ğŸ“ Create Root Cause Analysis Issue
        uses: actions/github-script@v7
        if: github.event_name == 'schedule'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `ğŸ“Š AnÃ¡lise de Causas RaÃ­zes - ${today}`;
            
            // Check if analysis issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'elevare-agent,analysis',
              per_page: 10
            });
            
            const existingAnalysis = issues.data.find(i => i.title.includes(today));
            
            if (existingAnalysis) {
              console.log('âœ… AnÃ¡lise de hoje jÃ¡ existe');
              return;
            }
            
            // Get all open bugs
            const bugs = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bug',
              per_page: 100
            });
            
            const body = `
            ## ğŸ” AnÃ¡lise AutomÃ¡tica de Causas RaÃ­zes
            
            **Data da AnÃ¡lise:** ${today}
            **Gerado por:** Elevare Agent ğŸ¤–
            
            ### ğŸ“Š Resumo
            
            - **Total de Bugs Abertos:** ${bugs.data.length}
            - **AnÃ¡lise:** Executada automaticamente
            
            ### ğŸ¯ AÃ§Ãµes Recomendadas
            
            1. âœ… Revisar issues priorizadas
            2. ğŸ”§ Agrupar issues relacionadas
            3. ğŸ“ Atualizar documentaÃ§Ã£o se necessÃ¡rio
            4. ğŸ§ª Adicionar testes para Ã¡reas problemÃ¡ticas
            
            ---
            
            _Este Ã© um relatÃ³rio automÃ¡tico gerado pelo Elevare Agent._
            _Para questÃµes sobre este relatÃ³rio, mencione @elevare-agent_
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['elevare-agent', 'analysis', 'documentation']
            });
            
            console.log(`âœ… Issue de anÃ¡lise criada: ${title}`);
