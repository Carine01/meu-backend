name: Elevare Auto Updates

on:
  schedule:
    # Runs weekly on Fridays at 10:00 UTC
    - cron: '0 10 * * 5'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-updates:
    name: ğŸ”„ Verificar AtualizaÃ§Ãµes
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Check for outdated packages
        id: outdated
        run: |
          npm outdated --json > outdated.json 2>&1 || true
          
          if [ -s outdated.json ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "âœ… Pacotes desatualizados encontrados"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Todos os pacotes estÃ£o atualizados"
          fi

      - name: ğŸ”’ Check for security vulnerabilities
        id: audit
        run: |
          npm audit --json > audit.json 2>&1 || true
          
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Count vulnerabilities
          HIGH_VULN=$(jq -r '.metadata.vulnerabilities.high // 0' audit.json)
          CRITICAL_VULN=$(jq -r '.metadata.vulnerabilities.critical // 0' audit.json)
          
          echo "high_vulns=$HIGH_VULN" >> $GITHUB_OUTPUT
          echo "critical_vulns=$CRITICAL_VULN" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL_VULN" -gt 0 ] || [ "$HIGH_VULN" -gt 0 ]; then
            echo "has_vulns=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Vulnerabilidades encontradas: $CRITICAL_VULN crÃ­ticas, $HIGH_VULN altas"
          else
            echo "has_vulns=false" >> $GITHUB_OUTPUT
            echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"
          fi

      - name: ğŸš¨ Create Security Issue if needed
        if: steps.audit.outputs.has_vulns == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const critical = ${{ steps.audit.outputs.critical_vulns }};
            const high = ${{ steps.audit.outputs.high_vulns }};
            
            const title = `ğŸš¨ Vulnerabilidades de SeguranÃ§a Detectadas: ${critical} crÃ­ticas, ${high} altas`;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,elevare-agent'
            });
            
            const recentSecurityIssue = issues.data.find(i => 
              i.title.includes('Vulnerabilidades de SeguranÃ§a Detectadas')
            );
            
            if (recentSecurityIssue) {
              console.log(`âš ï¸ Issue de seguranÃ§a jÃ¡ existe: #${recentSecurityIssue.number}`);
              return;
            }
            
            const fs = require('fs');
            const auditData = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            
            let vulnList = '';
            if (auditData.vulnerabilities) {
              for (const [pkg, data] of Object.entries(auditData.vulnerabilities)) {
                if (data.severity === 'critical' || data.severity === 'high') {
                  vulnList += `\n- **${pkg}**: ${data.severity} - ${data.via[0]?.title || 'Ver npm audit para detalhes'}`;
                }
              }
            }
            
            const body = `
            ## ğŸš¨ Alerta de SeguranÃ§a AutomÃ¡tico
            
            **Detectado por:** Elevare Agent ğŸ¤–
            **Data:** ${new Date().toISOString().split('T')[0]}
            
            ### ğŸ“Š Resumo
            
            - **Vulnerabilidades CrÃ­ticas:** ${critical}
            - **Vulnerabilidades Altas:** ${high}
            
            ### ğŸ” Pacotes Afetados
            ${vulnList || '_Ver npm audit para detalhes completos_'}
            
            ### ğŸ”§ AÃ§Ãµes Recomendadas
            
            1. Execute \`npm audit fix\` localmente
            2. Teste todas as funcionalidades apÃ³s atualizaÃ§Ã£o
            3. Se \`npm audit fix\` nÃ£o resolver, considere \`npm audit fix --force\`
            4. Verifique se hÃ¡ breaking changes nas atualizaÃ§Ãµes
            5. Atualize testes se necessÃ¡rio
            
            ### ğŸ“ Como Corrigir
            
            \`\`\`bash
            # Tente correÃ§Ã£o automÃ¡tica primeiro
            npm audit fix
            
            # Se necessÃ¡rio, use forÃ§a (cuidado com breaking changes)
            npm audit fix --force
            
            # Teste o aplicativo
            npm test
            npm run build
            \`\`\`
            
            ---
            
            **IMPORTANTE:** Este Ã© um alerta crÃ­tico. Priorize a correÃ§Ã£o destas vulnerabilidades.
            
            _Gerado automaticamente pelo Elevare Agent_
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'high-priority', 'elevare-agent', 'bug']
            });
            
            console.log('âœ… Issue de seguranÃ§a criada');

      - name: ğŸ“ Create Update Report Issue
        if: steps.outdated.outputs.has_updates == 'true' && steps.audit.outputs.has_vulns == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `ğŸ“¦ AtualizaÃ§Ãµes de DependÃªncias DisponÃ­veis - ${today}`;
            
            // Check if update issue already exists this week
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,elevare-agent'
            });
            
            const thisWeek = new Date().toISOString().split('T')[0].slice(0, 7); // YYYY-MM
            const recentUpdateIssue = issues.data.find(i => 
              i.title.includes('AtualizaÃ§Ãµes de DependÃªncias') &&
              i.title.includes(thisWeek)
            );
            
            if (recentUpdateIssue) {
              console.log(`âœ… Issue de atualizaÃ§Ã£o jÃ¡ existe esta semana: #${recentUpdateIssue.number}`);
              return;
            }
            
            const body = `
            ## ğŸ“¦ RelatÃ³rio de AtualizaÃ§Ãµes DisponÃ­veis
            
            **Gerado por:** Elevare Agent ğŸ¤–
            **Data:** ${today}
            
            ### ğŸ“Š Status
            
            Existem atualizaÃ§Ãµes disponÃ­veis para as dependÃªncias do projeto.
            
            ### ğŸ” Como Verificar
            
            Execute o seguinte comando para ver os detalhes:
            
            \`\`\`bash
            npm outdated
            \`\`\`
            
            ### ğŸ”§ Como Atualizar
            
            1. **AtualizaÃ§Ãµes menores (seguras):**
               \`\`\`bash
               npm update
               \`\`\`
            
            2. **AtualizaÃ§Ãµes maiores (requerem teste):**
               \`\`\`bash
               # Para cada pacote, avalie individualmente
               npm install package@latest
               \`\`\`
            
            3. **ApÃ³s atualizar:**
               \`\`\`bash
               npm test
               npm run build
               npm run start:dev  # Teste manual
               \`\`\`
            
            ### âœ… Checklist de AtualizaÃ§Ã£o
            
            - [ ] Revisar changelog dos pacotes principais
            - [ ] Atualizar dependÃªncias
            - [ ] Executar todos os testes
            - [ ] Fazer build do projeto
            - [ ] Testar funcionalidades principais
            - [ ] Criar PR com as atualizaÃ§Ãµes
            
            ---
            
            _Gerado automaticamente pelo Elevare Agent_
            _AtualizaÃ§Ãµes sÃ£o verificadas semanalmente_
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'elevare-agent', 'enhancement']
            });
            
            console.log('âœ… Issue de atualizaÃ§Ã£o criada');

      - name: âœ… All Up to Date
        if: steps.outdated.outputs.has_updates == 'false' && steps.audit.outputs.has_vulns == 'false'
        run: |
          echo "âœ… Todas as dependÃªncias estÃ£o atualizadas"
          echo "âœ… Nenhuma vulnerabilidade de seguranÃ§a detectada"
          echo "âœ… Sistema saudÃ¡vel!"
